{% extends "index.html" %}
{% block title %}Role Management{% endblock %}



{% block content %}    
            <div class="content-box">
                <div class="header" style="margin-bottom: 2rem;">
                    <h2>Roles List</h2>
                    <button class="btn-primary" id="addRoleBtn">
                        <i class="fas fa-plus"></i> Add Role
                    </button>
                </div>

                <div class="table-container">
                    <table id="rolesTable">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Role Name</th>
                                <th>Created At</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            <!-- Roles will be loaded here -->
                        </tbody>
                    </table>
                </div>
                
                <h3 style="margin-top: 3rem; margin-bottom: 1rem;">User Role Assignments</h3>
                <div class="table-container">
                    <table id="userRolesTable">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>User</th>
                                <th>Role</th>
                                <th>Assigned At</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            <!-- User roles will be loaded here -->
                        </tbody>
                    </table>
                </div>
            </div>

    

    <!-- Add Role Modal -->
    <div class="modal" id="roleModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Add New Role</h3>
                <button class="close-modal" id="closeRoleModal">&times;</button>
            </div>
            
            <form id="roleForm">
                <div class="form-group">
                    <label for="roleName">Role Name *</label>
                    <input type="text" id="roleName" name="name" required>
                </div>
                
                <div class="form-actions">
                    <button type="submit" class="btn-primary">
                        Save Role
                    </button>
                    <button type="button" class="btn-secondary" id="cancelRoleBtn">
                        Cancel
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Assign Role Modal -->
    <div class="modal" id="assignRoleModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Assign Role to User</h3>
                <button class="close-modal" id="closeAssignModal">&times;</button>
            </div>
            
            <form id="assignRoleForm">
                <div class="form-group">
                    <label for="assignUser">Select User *</label>
                    <select id="assignUser" name="user_id" required>
                        <option value="">Select user...</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="assignRole">Select Role *</label>
                    <select id="assignRole" name="role_id" required>
                        <option value="">Select role...</option>
                    </select>
                </div>
                
                <div class="form-actions">
                    <button type="submit" class="btn-primary">
                        Assign Role
                    </button>
                    <button type="button" class="btn-secondary" id="cancelAssignBtn">
                        Cancel
                    </button>
                </div>
            </form>
        </div>
    </div>


    
    <script>
        // Initialize session protection
        // checkSession();
        
        // Logout button
        document.getElementById('logoutBtn').addEventListener('click', () => {
            adminLogout();
            window.location.href = '{% url "login" %}';
        });
        
        // Load roles when page loads
        document.addEventListener('DOMContentLoaded', () => {
            loadRoles();
            loadUserRoles();
            loadUsersForAssignment();
            loadRolesForAssignment();
        });
        
        // Role modal controls
        const roleModal = document.getElementById('roleModal');
        const assignRoleModal = document.getElementById('assignRoleModal');
        const addRoleBtn = document.getElementById('addRoleBtn');
        
        addRoleBtn.addEventListener('click', () => {
            document.getElementById('roleForm').reset();
            roleModal.style.display = 'flex';
        });
        
        document.getElementById('closeRoleModal').addEventListener('click', () => {
            roleModal.style.display = 'none';
        });
        
        document.getElementById('cancelRoleBtn').addEventListener('click', () => {
            roleModal.style.display = 'none';
        });
        
        // Assign role modal controls
        document.getElementById('closeAssignModal').addEventListener('click', () => {
            assignRoleModal.style.display = 'none';
        });
        
        document.getElementById('cancelAssignBtn').addEventListener('click', () => {
            assignRoleModal.style.display = 'none';
        });
        
        // Show assign role modal
        window.showAssignRoleModal = function() {
            assignRoleModal.style.display = 'flex';
        };
        
        // Close modals when clicking outside
        window.addEventListener('click', (e) => {
            if (e.target === roleModal) {
                roleModal.style.display = 'none';
            }
            if (e.target === assignRoleModal) {
                assignRoleModal.style.display = 'none';
            }
        });
        
        // Handle role form submission
        document.getElementById('roleForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const roleData = {
                name: document.getElementById('roleName').value
            };
            
            try {
                await createRole(roleData);
                roleModal.style.display = 'none';
                loadRoles();
                loadRolesForAssignment();
            } catch (error) {
                alert('Error saving role: ' + error.message);
            }
        });
        
        // Handle assign role form submission
        document.getElementById('assignRoleForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const assignmentData = {
                user_id: parseInt(document.getElementById('assignUser').value),
                role_id: parseInt(document.getElementById('assignRole').value)
            };
            
            try {
                await assignRoleToUser(assignmentData);
                assignRoleModal.style.display = 'none';
                loadUserRoles();
            } catch (error) {
                alert('Error assigning role: ' + error.message);
            }
        });
    </script>
{% endblock %}